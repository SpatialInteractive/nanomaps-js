(function(d){function b(){this.style.visibility=""}function c(){var h={},g=[];function f(i){if(i.img&&i.img.parentNode){i.img.parentNode.removeChild(i.img)}}this.mark=function(){g.length=0};this.free=function(){var k={},m,l,j;for(l=0;l<g.length;l++){j=g[l];m=j.key;k[m]=j;delete h[m]}for(l in h){j=h[l];f(j)}h=k;g.length=0};this.use=function(i){var j=i.key,k=h[j];if(k){f(i);i=k}h[j]=i;if(g){g.push(i)}return i};this.take=function(i){var j=i.key,k=h[j];if(k){delete h[j];return k}return i};this.each=function(l){var k,j;for(k in h){j=h[k];if(j&&typeof j==="object"){l(j)}}};this.clear=function(){h={};g.length=0};this.moveFrom=function(i){i.each(function(j){var k=j.key;if(h[k]){f(j)}else{h[j.key]=j}});i.clear()}}function e(f){this.options=f=f||{};this.sel=new a(f);this.fgCache=new c();this.bgCache=new c()}e.prototype={createElement:function(g){var f=document.createElement("div");f.style.position="absolute";f.style.left="0px";f.style.top="0px";f.mapDelegate=this;return f},placeTile:function(m,k,g,i){var h=g.img,j=m.transform,f=j.zpx,l=g.res/j.res;if(h&&h._error){if(h.parentElement){h.parentElement.removeChild(h)}g.img=null;h=null}if(!h){h=m.createElement("img");h.style.visibility="hidden";h.onload=b;h.style.position="absolute";h.src=this.sel.resolveSrc(g);g.img=h}h.width=Math.ceil(g.size*l);h.height=Math.ceil(g.size*l);h.style.left=Math.round(g.x*l-f[0])+"px";h.style.top=Math.round(f[1]-g.y*l)+"px";if(i||h.parentNode!==k){k.appendChild(h)}},onreset:function(f,n){var v=this,j=f.transform,l=v.options.buffer||64,p=f.toGlobalPixels(-l,-l),g=f.width+l,u=f.height+l,s=v.curResolution,h=j.res,r=v.sel.select(j.prj,h,p.x,p.y,g,u,true),t=v.fgCache,o=v.bgCache,k=false,m,q;if(s&&s!==h){o.mark();o.free();o.moveFrom(t);k=true}t.mark();for(m=0;m<r.length;m++){q=t.use(o.take(r[m]));v.placeTile(f,n,q,true)}t.free();this.curResolution=h;if(k){o.each(function(i){v.placeTile(f,n,i)})}},onposition:function(g,f){this.onreset(g,f)}};function a(f){f=f||{};this.tileSize=f.tileSize||256;this.srcSpec="http://otile${modulo:1,2}.mqcdn.com/tiles/1.0.0/osm/${level}/${tileX}/${tileY}.png"}a.prototype={origin:function(f){var g=this._origin;if(!g){g=f.forward(-180,85.05112878);this._origin=g}return g},resolveSrc:function(f){return this.srcSpec.replace(/\$\{([A-Za-z]+)(\:([^\}]*))?\}/g,function(i,h,j,g){if(h==="modulo"){g=g.split(/\,/);return g[f.tileX%g.length]}else{return f[h]}})},select:function(F,v,n,l,u,r,D){var t,s,G,E,k,h,B,z,w,f=Math.round(F.toLevel(v)),m=F.fromLevel(f),q=this.origin(F),o=this.tileSize,C=q[0]/m,A=q[1]/m,p=v/m,g=[];n=n*p;l=l*p;u=u*p;r=r*p;t=Math.floor((n-C)/o);s=Math.floor((A-l)/o);G=Math.floor(((n+u)-C)/o);E=Math.floor((A-(l-r))/o);for(z=s;z<=E;z++){for(B=t;B<=G;B++){w={key:f+":"+B+":"+z,res:m,level:f,tileX:B,tileY:z,size:o,x:C+B*o,y:A-z*o};g.push(w)}}if(D){k=(t+G)/2;h=(s+E)/2;g.sort(function(I,x){var K=Math.abs(I.tileX-k),H=Math.abs(I.tileY-h),y=K*K+H*H,J=Math.abs(x.tileX-k),j=Math.abs(x.tileY-h),i=J*J+j*j;return y-i})}return g}};d.TileSelector=a;d.TileLayer=e})(nanomaps);