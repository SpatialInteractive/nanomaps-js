function TileLayer(a){if(!a){a={}}var e=this.peer=new TileLayerPeer();var d=e.sel=new CartesianTileSelector(a);var c=Number(a.pixelRatio);if(!c&&a.autoPixelRatio){c=window.devicePixelRatio}d.pixelRatio=e.pixelRatio=this.pixelRatio=c||1;var b=this.element=document.createElement("div");b.style.position="absolute";b.style.left="0px";b.style.top="0px";if(c){b.style.zoom=(1/c)}b.mapeer=e;b.setAttribute("tilesrc",d.toString())}TileLayer.prototype={unmanaged:true,defaultLayer:"map",getElement:function(a){this.owner=a;return this.element}};function TileLayerPeer(){this.lockedState=null;this.current=new TileSet();this.old=new TileSet();this.transition=new TileSet()}TileLayerPeer.prototype={maposition:function(b,a){this.mareset(b,a)},loadPendingTiles:function(d){var j=this.transition,e=this.current,b=this.pixelRatio,l=b*(d.w-1),a=b*(d.h-1),h,f,k,g,c=[];j.clear();h=this.sel.select(d.prj,d.res/b,d.getPrjX(0,0),d.getPrjY(0,0),d.getPrjX(l,a),d.getPrjY(l,a));for(f=0;f<h.length;f++){k=h[f];g=e.move(k,j);if(!g){g=new Tile(this.sel,k);j.add(g);c.push(g);setTileBounds(d,g,b)}}sortTiles(c,b*d.w/2,b*d.h/2);for(f=0;f<c.length;f++){g=c[f];g.loading=true;this.sel.loadTile(g,null,true)}},mareset:function(b,k){var h=this.current,n=this.transition,e=this.old,f=b.mapState,g=this.lockedState,c=this.pixelRatio,p=c*(f.w-1),a=c*(f.h-1),m,j,o,l,d=[];if(g!==f.finalState){g=this.lockedState=f.finalState;if(g){this.loadPendingTiles(g)}}h.resetMarks();m=this.sel.select(f.prj,f.res/c,f.getPrjX(0,0),f.getPrjY(0,0),f.getPrjX(p,a),f.getPrjY(p,a));for(j=0;j<m.length;j++){o=m[j];l=h.get(o)||n.move(o,h);if(!g&&l&&l.temporary){l=null}if(!l){l=new Tile(this.sel,o);if(g){l.temporary=true}h.add(l)}l.mark=true;setTileBounds(f,l,c);if(!l.parent){d.push(l)}}if(d.length>0){h.sweep(e,function(i){setTileBounds(f,i,c)})}sortTiles(d,c*f.w/2,c*f.h/2);for(j=0;j<d.length;j++){l=d[j];if(!l.loading&&!l.temporary){l.loading=true;this.sel.loadTile(l)}if(!l.drawable){l.generatePreview(e)}l.attach(k)}h.sweep();e.sweep();if(!g){n.clear()}}};function sortTiles(b,a,c){b.sort(function(e,d){var g=Math.abs(e.left+e.width/2-a)+Math.abs(e.top+e.height/2-c),f=Math.abs(d.left+d.width/2-a)+Math.abs(d.top+d.height/2-c);return g-f})}function setTileBounds(c,d,h){var b=d.sel.tileSize,g=d.tileKey,a=h*Math.ceil(b*g.res/c.res),f=h*Math.floor(c.prjToDspX(g.scaledX*g.res)-c.x),e=h*Math.floor(c.prjToDspY(g.scaledY*g.res)-c.y);d.setBounds(f,e,a,a)}function CartesianTileSelector(a){a=a||{};this.tileSize=a.tileSize||256;this.srcSpec=a.tileSrc||"";this.pending={}}CartesianTileSelector.prototype={toString:function(){return this.srcSpec},_sched:function(e){var b=this,d=e.tile.tileKey.id,a=e.img;a.onload=function(){e.loaded=true;c();if(e.tile){e.tile.update(a)}};a.onerror=function(){c()};function c(){e.time=now()-e.time;delete b.pending[d]}b.pending[d]=e;a.src=e.src},loadTile:function(a){var b={tile:a,src:this.resolveSrc(a.tileKey),img:document.createElement("img"),loaded:false,time:now()};this._sched(b)},destroyTile:function(a){var c=a.tileKey.id;var b=this.pending[c];if(b&&b.tile===a){delete this.pending[c];b.img.src="data:image/png,"}},destroyDrawable:function(b,a){},resolveSrc:function(b){var a=this;return a.srcSpec.replace(/\$\{([A-Za-z]+)(\:([^\}]*))?\}/g,function(e,d,f,c){if(d==="quadkey"){return tileXYToQuadkey(b.tileX,b.tileY,b.level)}else{if(d==="modulo"){c=c.split(/\,/);return c[b.tileX%c.length]}else{if(d==="pixelRatio"){return a.pixelRatio||1}else{return b[d]}}}})},select:function(x,o,v,e,t,d){var m=this.tileSize,n=x.PRJ_EXTENT,g=x.XINVERTED,f=x.YINVERTED,c=Math.round(x.toLevel(o)),k=x.fromLevel(c),s,r;v/=k;e/=k;t/=k;d/=k;if(f){r=n.maxy/k;e=r-e;d=r-d}else{r=n.miny/k;e=e-r;d=d-r}if(g){s=n.maxx/k;v=s-v;t=s-t}else{s=n.minx/k;v=v-s;t=t-s}var w=Math.floor(Math.min(v,t)/m),u=Math.floor(Math.min(e,d)/m),b=Math.floor(Math.max(v,t)/m),a=Math.floor(Math.max(d,d)/m),q,p,l,h,y=[];for(p=u;p<=a;p++){if(f){h=r-p*m}else{h=r+p*m}for(q=w;q<=b;q++){if(g){l=s-q*m}else{l=s+q*m}y.push(new CartesianTileKey(c,q,p,k,l,h,m))}}return y}};function CartesianTileKey(g,f,e,c,d,b,a){this.id=f+","+e+"@"+g;this.level=g;this.tileX=f;this.tileY=e;this.res=c;this.scaledX=d;this.scaledY=b;this.size=a}function Tile(a,b){this.sel=a;this.tileKey=b;this.drawable=null;this.parent=null;this.left=null;this.top=null;this.width=null;this.height=null;this.mark=false;this.temporary=false;this.loading=false}Tile.prototype={_commitBounds:function(a){a.style.position="absolute";a.style.left=this.left+"px";a.style.top=this.top+"px";a.style.width=this.width+"px";a.style.height=this.height+"px"},update:function(a){var b=this.drawable;this.drawable=a;a.setAttribute("tileid",this.tileKey.id);if(this.parent){this._commitBounds(a);if(b){this.parent.replaceChild(a,b)}else{this.parent.appendChild(a)}}if(b){this.sel.destroyDrawable(this,b)}},setBounds:function(e,d,c,a){var b=this.drawable;this.left=parseInt(e);this.top=parseInt(d);this.width=parseInt(c);this.height=parseInt(a);if(b){this._commitBounds(b)}},attach:function(b){var a=this.drawable;if(this.parent&&b!==this.parent){this.detach()}this.parent=b;if(a){this._commitBounds(a);if(!a.parentNode){b.appendChild(a)}}},detach:function(){var a=this.drawable;this.parent=null;if(a&&a.parentNode){a.parentNode.removeChild(a)}},dispose:function(){this.detach();if(this.drawable){this.sel.destroyDrawable(this,this.drawable);this.drawable=null}this.sel.destroyTile(this)},generatePreview:function(b){var a=this,c=null;b.intersect(a,function(f){if(!c){try{c=new TileCompositor(a)}catch(d){}}if(c){c.add(f)}});if(c){a.update(c.drawable)}}};function TileCompositor(c){var b=document.createElement("canvas"),a;b.width=c.width;b.height=c.height;a=b.getContext("2d");this.drawable=b;this.add=function(d){var r=d.left-c.left,q=d.top-c.top,n=0,m=0,p,k,i,o=d.width,j=d.height,g=d.tileKey.size/d.width,f=d.tileKey.size/d.height;if(r<0){n=-r;r=0;o-=n}if(q<0){m=-q;q=0;j-=m}i=r+o-c.width;if(i>=0){o-=i}i=q+j-c.height;if(i>=0){j-=i}n*=g;m*=f;p=o*g;k=j*f;try{a.drawImage(d.drawable,n,m,p,k,r,q,o,j)}catch(l){}}}function TileSet(){this._c={}}TileSet.prototype={each:function(d){var b=this._c,a;for(a in b){if(b.hasOwnProperty(a)){d(b[a])}}},resetMarks:function(){this.each(function(a){a.mark=false})},get:function(a){return this._c[a.id]},add:function(b){var e=b.tileKey.id,d=this._c;var a=d[e];if(a){a.dispose()}d[e]=b},move:function(d,b){var f=d.id,e=this._c,a=e[f];if(a){delete e[f];b.add(a)}return a},sweep:function(d,a){var g=this._c,e=[],b,f;for(b in g){if(g.hasOwnProperty(b)){f=g[b];if(!f.mark){if(d){d.add(f)}else{f.dispose()}if(a){a(f)}e.push(b)}}}for(b=0;b<e.length;b++){delete g[e[b]]}},clear:function(){var e=this._c,b=[],a,d;for(a in e){if(e.hasOwnProperty(a)){d=e[a];d.dispose()}}this._c={}},intersect:function(g,i){var e=this._c,a,b,j=g.left,h=g.top,f=j+g.width,d=h+g.height;for(a in e){if(e.hasOwnProperty(a)){b=e[a];if(b.drawable&&!(b.left>=f||(b.left+b.width)<j||b.top>=d||(b.top+b.height)<h)){i(b)}}}}};nanomaps.CartesianTileSelector=CartesianTileSelector;nanomaps.TileLayer=TileLayer;