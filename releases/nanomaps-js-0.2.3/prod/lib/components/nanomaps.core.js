function MapState(a){if(a){a.copy(this)}else{this.prj=null;this.res=1;this.x=0;this.y=0;this.w=0;this.h=0}this.finalState=null}MapState.prototype={compare:function(a){var b=0;if(this.x!==a.x||this.y!==a.y||this.w!==a.w||this.h!==a.h){b=1}if(this.prj!==a.prj||this.res!==a.res){b=2}return b},copy:function(a){a.x=this.x;a.y=this.y;a.w=this.w;a.h=this.h;a.prj=this.prj;a.res=this.res},getZoom:function(){return this.prj.toLevel(this.res)},getDspX:function(a,b){return this.x+a},getDspY:function(a,b){return this.y+b},getPrjX:function(a,d){var b=this.prj,c=this.getDspX(a,d)*this.res;if(b.XINVERTED){c=b.PRJ_EXTENT.maxx-c}return c},getPrjY:function(a,d){var b=this.prj,c=this.getDspY(a,d)*this.res;if(b.YINVERTED){c=b.PRJ_EXTENT.maxy-c}return c},getGlbX:function(a,b){return this.prj.invX(this.getPrjX(a,b))},getGlbY:function(a,b){return this.prj.invY(this.getPrjY(a,b))},prjToDspX:function(a){var b=this.prj;if(b.XINVERTED){a=b.PRJ_EXTENT.maxx-a}return a/this.res},prjToDspY:function(a){var b=this.prj;if(b.YINVERTED){a=b.PRJ_EXTENT.maxy-a}return a/this.res},setRes:function(d,a,e){if(d!==this.res){var c=this.getPrjX(a,e),b=this.getPrjY(a,e);this.res=d;this.setPrjXY(c,b,a,e)}},setZoom:function(c,a,b){this.setRes(this.prj.fromLevel(c),a,b)},setDspXY:function(c,b,a,d){this.x=c-a;this.y=b-d},setPrjXY:function(c,b,a,d){this.setDspXY(this.prjToDspX(c),this.prjToDspY(b),a,d)},setGlbXY:function(d,c,a,e){var b=this.prj;this.setPrjXY(b.fwdX(d),b.fwdY(c),a,e)}};function MapSurface(c,j){if(!j){j={}}var g=j.document||c.ownerDocument||window.document,a=j.width,h=j.height,f,i,d,e;function b(k){return g.createElement(k)}this.createElement=b;this._layers=[];this._surfaces=[];c.nmt="parent";c.style.overflow="hidden";if(!isPositioned(c)){c.style.position="relative"}this.elements={document:g,parent:c};i=this.layer(LAYER_NAMES.EVENT);i.style.position="absolute";i.style.left="0px";i.style.top="0px";i.style.width="100%";i.style.height="100%";this.elements.event=i;this.mapState=d=new MapState();d.prj=j.projection||new Projections.WebMercator();d.res=j.resolution||d.prj.DEFAULT_RESOLUTION;this._zoomBias=j.zoomBias||0;this._pendMapState=new MapState(d);this._pendLock=0;this._pendAnim=null;if(typeof a!=="number"||typeof h!=="number"){this.setSize();a=c.clientWidth;h=c.clientHeight}else{this.setSize(a,h)}this.initialize(j);this.collect()}var MapSurfaceMethods=MapSurface.prototype=new EventEmitter();function optionalX(b,a){return(a===undefined||a===null)?b.mapState.w/2:Number(a)}function optionalY(a,b){return(b===undefined||b===null)?a.mapState.h/2:Number(b)}function clampZoom(b,c){var a=b.mapState.prj;c=Number(c);if(isNaN(c)){c=a.MAX_LEVEL}if(c<a.MIN_LEVEL){c=a.MIN_LEVEL}else{if(c>a.MAX_LEVEL){c=a.MAX_LEVEL}}return c}var LAYER_NAMES={BACKGROUND:0,MAP:10,SHADOW:50,EVENT:100,OVERLAY:1000,FOREGROUND:10000};function layerIndexToOrdinal(b){var a=LAYER_NAMES[String(b).toUpperCase()];if(a===undefined){a=parseInt(b);if(isNaN(a)){a=LAYER_NAMES.FOREGROUND}}return a}function makeMapStateFramer(a,j,g){var e=g.res-j.res,h=j.getPrjX(0,0),c=j.getPrjY(0,0),b=g.getPrjX(0,0)-h,i=g.getPrjY(0,0)-c,f=g.w-j.w,d=g.h-j.h;j=new MapState(j);g=new MapState(g);updateMapState=new MapState(j);return function(p,l,o){var k=l[0],m;if(o){updateMapState=g;a._pendAnim=null;a.mapState.finalState=null}else{updateMapState.res=j.res+k*e;updateMapState.setPrjXY(h+k*b,c+k*i,0,0);updateMapState.w=j.w+k*f;updateMapState.h=j.h+k*d}m=updateMapState.compare(a.mapState);if(m>0){updateMapState.copy(a.mapState);a._invalidate(m>1)}}}MapSurfaceMethods.begin=function(){return this._pendLock++===0};MapSurfaceMethods.rollback=function(){this.mapState.copy(this._pendMapState);this._pendLock=0};MapSurfaceMethods.commit=function(b){if(this._pendLock<=0||--this._pendLock>0){return false}var a=this._pendMapState,d=this.mapState,c;var e=a.compare(d);if(e>0){if(this._pendAnim){this._pendAnim.interrupt();this._pendAnim=null;d.finalState=null}if(!b){a.copy(d);this._invalidate(e>1)}else{if(typeof b==="object"){c=b}d.finalState=new MapState(a);this._pendAnim=new Animation(makeMapStateFramer(this,d,a),c);this._pendAnim.start()}}return true};MapSurfaceMethods.forceCommit=function(){this._pendLock=1;this.commit()};MapSurfaceMethods.layer=function(b){var f=this.elements.parent,g=this._layers,e,d,a=layerIndexToOrdinal(b),h,c;for(d=0;d<g.length;d++){e=g[d];if(e.ordinal===a){return e}}e=this.createElement("div");e.ordinal=a;e.nmt="layer";e.setAttribute("layer",String(a));e.style.width="0px";e.style.height="0px";g.push(e);for(c=f.firstChild;c;c=c.nextSibling){if(c.nodeType===1&&c.nmt){h=c.ordinal;if(h!==undefined&&h>a){break}}}f.insertBefore(e,c);return e};MapSurfaceMethods.surface=function(d){var c=layerIndexToOrdinal(d),g=this.mapState,b=this._surfaces,a,f,e;for(f=0;f<b.length;f++){a=b[f];if(a.ordinal===c){return a}}a=this.createElement("div");a.ordinal=c;a.nmt="surface";a.className="managed";a.style.position="absolute";a.style.left=(-g.x)+"px";a.style.top=(-g.y)+"px";b.push(a);e=this.layer(c);e.insertBefore(a,e.firstChild);return a};MapSurfaceMethods.getZoom=function(){return this._pendMapState.getZoom()-this._zoomBias};MapSurfaceMethods.setZoom=function(e,a,d){var b=this._pendMapState,c=b.res;this.begin();e=clampZoom(this,e+this._zoomBias);b.setZoom(e,optionalX(this,a),optionalY(this,d));this.commit()};MapSurfaceMethods.zoomIn=function(a,b){this.setZoom(Math.round(this.getZoom()+1),a,b)},MapSurfaceMethods.zoomOut=function(a,b){this.setZoom(Math.round(this.getZoom()-1),a,b)},MapSurfaceMethods.getLocation=function(a,c){var b=this._pendMapState;a=optionalX(this,a);c=optionalY(this,c);return Coordinate.xy(b.getGlbX(a,c),b.getGlbY(c,c))};MapSurfaceMethods.setLocation=function(b,a,c){b=Coordinate.from(b);this.begin();this._pendMapState.setGlbXY(b._x,b._y,optionalX(this,a),optionalY(this,c));this.commit()};MapSurfaceMethods._invalidate=function(d){var e=this.mapState,b=this._surfaces,a,c;for(c=0;c<b.length;c++){a=b[c];a.style.left=(-e.x)+"px";a.style.top=(-e.y)+"px"}if(d){this._notifyReset()}else{this._notifyPosition()}};MapSurfaceMethods._each=function(e,g){var f=this._layers,a=this._surfaces,b,c,d;for(c=0;c<f.length;c++){b=f[c];for(var d=b.firstChild;d;d=d.nextSibling){if(d.nodeType!==1||d.nmt==="surface"){continue}g.call(this,d)}}if(e){for(c=0;c<a.length;c++){b=a[c];for(var d=b.firstChild;d;d=d.nextSibling){if(d.nodeType!==1){continue}g.call(this,d)}}}};MapSurfaceMethods._notifyPosition=function(){this._each(false,function(a){var b=a.mapeer||DefaultAttachmentPeer;if(isFunction(b.maposition)){b.maposition(this,a)}})};MapSurfaceMethods._notifyReset=function(){this._each(true,this._notifyResetSingle)};MapSurfaceMethods._notifyResetSingle=function(a){var b=a.mapeer||DefaultAttachmentPeer;if(isFunction(b.mareset)){b.mareset(this,a)}};MapSurfaceMethods.initialize=function(a){};MapSurfaceMethods.eventToContainer=function(c,a){var b=this.elements[a||"parent"],f=b,d={x:c.clientX,y:c.clientY},e;do{e=parseInt(getComputedStyle(f,"zoom"))||1;d.x-=f.offsetLeft;d.y-=f.offsetTop;d.x/=e;d.y/=e}while(f=f.offsetParent);d.x+=window.pageXOffset||0;d.y+=window.pageYOffset||0;return d};function getAttachmentElement(a,b){if(isHtmlElement(b)){return b}if(!b||!isFunction(b.getElement)){throw new Error("Object "+b+" is not a valid Attachment")}return b.getElement(a)}MapSurfaceMethods.attach=function(h,b){if(!b){b={}}var a=b.layer,f=b.unmanaged,d,c=getAttachmentElement(this,h);if(h!==c){if(!a){a=h.defaultLayer}f=h.unmanaged}c.style.position="absolute";d=f?this.layer(a):this.surface(a);if(c.parentNode===d){return}try{d.appendChild(c)}catch(g){throwNotDomElement(c)}this._notifyResetSingle(c);return c};MapSurfaceMethods.detach=function(b){var a=getAttachmentElement(this,b);if(a.parentNode){a.parentNode.removeChild(a)}};MapSurfaceMethods.collect=function(){};MapSurfaceMethods.update=function(c){var a=getAttachmentElement(this,c),b=a.parentNode;if(!b||!b.nmt){this.attach(c)}else{this._notifyResetSingle(a)}return a};MapSurfaceMethods.setSize=function(e,b){var c=this.elements.parent,a=this.getLocation(),d=this._pendMapState;this.begin();if(arguments.length<2){c.style.width="";c.style.height="";e=c.clientWidth;b=c.clientHeight}c.style.width=e+"px";c.style.height=b+"px";d.w=e;d.h=b;this.setLocation(a);this.commit()};MapSurfaceMethods.moveBy=function(c,b){var a=this.getLocation(c,-b);this.setLocation(a,0,0)};MapSurfaceMethods.globalToXY=function(d){var c=this.mapState,b=c.prj,a,e;d=Coordinate.from(d);a=c.prjToDspX(b.fwdX(d._x));e=c.prjToDspY(b.fwdY(d._y));return(isNaN(a)||isNaN(e))?null:new Coordinate(a,e)};function extractDefaultPosition(a){var b=a.geo;if(!b){b={};if(isNaN(b.latitude=Number(a.getAttribute("latitude")||"NaN"))){return null}if(isNaN(b.longitude=Number(a.getAttribute("longitude")||"NaN"))){return null}b.xoffset=Number(a.getAttribute("xoffset")||"NaN");b.yoffset=Number(a.getAttribute("yoffset")||"NaN")}return b}var DefaultAttachmentPeer={mareset:function(e,b){var d=extractDefaultPosition(b),c,a,f;if(d){c=e.globalToXY(d);if(c){a=c.x()+Number(d.xoffset||0);f=c.y()+Number(d.yoffset||0);b.style.left=(a)+"px";b.style.top=(f)+"px";b.style.display="block";return}}b.style.display="none"}};exports.MapSurface=MapSurface;exports.DefaultAttachmentPeer=DefaultAttachmentPeer;